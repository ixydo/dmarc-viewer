function getCookie(e){var o=null;if(document.cookie&&""!=document.cookie)for(var t=document.cookie.split(";"),n=0;n<t.length;n++){var s=jQuery.trim(t[n]);if(s.substring(0,e.length+1)==e+"="){o=decodeURIComponent(s.substring(e.length+1));break}}return o}$.ajaxSetup({beforeSend:function(e,o){/^http:.*/.test(o.url)||/^https:.*/.test(o.url)||e.setRequestHeader("X-CSRFToken",getCookie("csrftoken"))}}),$(document).ready(function(){$(".context-help-icon").tooltip()}),$(document).on("click","[data-formset-add], .formset-copy",function(){$(".context-help-icon").tooltip()});var main={showAjaxMessages:function(e){"ajax_message_block"in e&&($(".bootstrap-messages-container").hide("slow"),$(".bootstrap-messages-container").html(e.ajax_message_block),$(".bootstrap-messages-container").show("slow"))}};
var editor={copyFilterSet:function(e){var i="#filterSetContainer";$(document).one("formAdded",i,function(i){var t=$(i.target),r=$(e).closest("[data-formset-form]");["filter_label","filter_color","filter_source_ip"].forEach(function(e){var i="."+e+" input";t.find(i).val(r.find(i).val())}),["filter_report_receiver_domain","filter_report_sender","filter_raw_spf_domain","filter_raw_spf_result","filter_raw_dkim_domain","filter_raw_dkim_result","filter_aligned_spf_result","filter_aligned_dkim_result","filter_disposition"].forEach(function(e){var i="."+e+" select",d=t.find(i)[0].selectize,a=r.find(i)[0].selectize;for(var n in a.options){var o=a.options[n].value,l=a.options[n].text;d.addOption({value:o,text:l}),-1!=a.items.indexOf(o)&&d.addItem(o,!0),d.refreshItems()}i=".filter_multiple_dkim input";t.find(i).prop("checked",r.find(i).is(":checked"))})}),$(i).data("formset").addForm()},toggleDateRange:function(){var e=$("[name='dr_type']:checked").val();$("[name='dr_type']").closest(".radio").removeClass("active"),1==e?($("[name='dr_type']:checked").closest(".radio").addClass("active"),$("#id_quantity, #id_unit").prop("disabled",!0).val(null),$("#id_quantity_container, #id_unit_container").addClass("disabled"),$("#id_begin, #id_end").prop("disabled",!1),$("#id_begin_container, #id_end_container").removeClass("disabled")):2==e&&($("[name='dr_type']:checked").closest(".radio").addClass("active"),$("#id_begin, #id_end").prop("disabled",!0).val(null),$("#id_begin_container, #id_end_container").addClass("disabled"),$("#id_quantity, #id_unit").prop("disabled",!1),$("#id_quantity_container, #id_unit_container").removeClass("disabled"))},_xhr:null,loadChoices:function(e){!e.length||e.length<3||(editor._xhr&&editor._xhr.abort(),this.load(function(i){editor._xhr=$.ajax({url:this.settings.load_action,data:{report_type:$("[name='report_type']").val(),choice_type:this.settings.load_choice_type,query_str:e},success:function(e){var t=e.choices.map(function(e){return{value:e,text:e}});i(t)},error:function(){i()}})}))}};
var analysis={overview:{init:function(t,a){$("#t"+t+"-container").addClass("loading"),$.get(a,{report_type:t},function(a){analysis.overview.appendPies(a,"#t"+t+"-container .charts-container"),$("#t"+t+"-domain-cnt").html(a.domain_cnt),$("#t"+t+"-report-cnt").html(a.report_cnt),$("#t"+t+"-message-cnt").html(a.message_cnt),$("#t"+t+"-container .text-container").show()}).always(function(){$("#t"+t+"-container").removeClass("loading")})},appendPies:function(t,a){function e(t,a){var e=[];return a.forEach(function(a){var n=t.filter(function(t){if(t.label==a)return!0});n.length>0&&e.push(n[0])}),e}t.dkim=e(t.dkim,["pass","fail"]),t.spf=e(t.spf,["pass","fail"]),t.disposition=e(t.disposition,["none","quarantine","reject"]),["dkim","spf","disposition"].forEach(function(e){var n,l=50,i=50;n="disposition"==e?d3.scale.ordinal().domain(["reject","quarantine","none"]).range(["#998ec3","#f1a340","#f7f7f7"]):d3.scale.ordinal().domain(["fail","pass"]).range(["#d95f02","#1b9e77"]);var s=d3.svg.arc().outerRadius(80).innerRadius(0),r=d3.layout.pie().sort(null).value(function(t){return t.cnt}),o=d3.select(a).append("svg").attr("class",e).attr("width",250+i).attr("height",200+l).append("g").attr("transform","translate("+(125+i)+","+(100+l)+")").selectAll(".arc").data(r(t[e])).enter().append("g").attr("class","arc");o.append("path").attr("d",s).attr("stroke-width",.5).attr("stroke","lightgrey").style("fill",function(t){return n(t.data.label)}),title="spf"==e||"dkim"==e?"aligned "+e.toUpperCase():e.toUpperCase(),o.append("text").attr("transform","translate(0, -120)").attr("text-anchor","middle").text(title);var d={legendItems:t[e].map(function(t){return{color:n(t.label),name:t.cnt+" "+t.label}})};o.append("g").attr("class","legend").attr("transform","translate(-160, -100)").style("font-size","12px").call(d3.legend,d)})}},map:{_map:null,_dataSets:[],_mapDataSets:[],_width:null,_countryCodeMapping:{AF:"AFG",AX:"ALA",AL:"ALB",DZ:"DZA",AS:"ASM",AD:"AND",AO:"AGO",AI:"AIA",AQ:"ATA",AG:"ATG",AR:"ARG",AM:"ARM",AW:"ABW",AU:"AUS",AT:"AUT",AZ:"AZE",BS:"BHS",BH:"BHR",BD:"BGD",BB:"BRB",BY:"BLR",BE:"BEL",BZ:"BLZ",BJ:"BEN",BM:"BMU",BT:"BTN",BO:"BOL",BQ:"BES",BA:"BIH",BW:"BWA",BV:"BVT",BR:"BRA",IO:"IOT",BN:"BRN",BG:"BGR",BF:"BFA",BI:"BDI",CV:"CPV",KH:"KHM",CM:"CMR",CA:"CAN",KY:"CYM",CF:"CAF",TD:"TCD",CL:"CHL",CN:"CHN",CX:"CXR",CC:"CCK",CO:"COL",KM:"COM",CD:"COD",CG:"COG",CK:"COK",CR:"CRI",CI:"CIV",HR:"HRV",CU:"CUB",CW:"CUW",CY:"CYP",CZ:"CZE",DK:"DNK",DJ:"DJI",DM:"DMA",DO:"DOM",EC:"ECU",EG:"EGY",SV:"SLV",GQ:"GNQ",ER:"ERI",EE:"EST",ET:"ETH",FK:"FLK",FO:"FRO",FJ:"FJI",FI:"FIN",FR:"FRA",GF:"GUF",PF:"PYF",TF:"ATF",GA:"GAB",GM:"GMB",GE:"GEO",DE:"DEU",GH:"GHA",GI:"GIB",GR:"GRC",GL:"GRL",GD:"GRD",GP:"GLP",GU:"GUM",GT:"GTM",GG:"GGY",GN:"GIN",GW:"GNB",GY:"GUY",HT:"HTI",HM:"HMD",VA:"VAT",HN:"HND",HK:"HKG",HU:"HUN",IS:"ISL",IN:"IND",ID:"IDN",IR:"IRN",IQ:"IRQ",IE:"IRL",IM:"IMN",IL:"ISR",IT:"ITA",JM:"JAM",JP:"JPN",JE:"JEY",JO:"JOR",KZ:"KAZ",KE:"KEN",KI:"KIR",KP:"PRK",KR:"KOR",KW:"KWT",KG:"KGZ",LA:"LAO",LV:"LVA",LB:"LBN",LS:"LSO",LR:"LBR",LY:"LBY",LI:"LIE",LT:"LTU",LU:"LUX",MO:"MAC",MK:"MKD",MG:"MDG",MW:"MWI",MY:"MYS",MV:"MDV",ML:"MLI",MT:"MLT",MH:"MHL",MQ:"MTQ",MR:"MRT",MU:"MUS",YT:"MYT",MX:"MEX",FM:"FSM",MD:"MDA",MC:"MCO",MN:"MNG",ME:"MNE",MS:"MSR",MA:"MAR",MZ:"MOZ",MM:"MMR",NA:"NAM",NR:"NRU",NP:"NPL",NL:"NLD",NC:"NCL",NZ:"NZL",NI:"NIC",NE:"NER",NG:"NGA",NU:"NIU",NF:"NFK",MP:"MNP",NO:"NOR",OM:"OMN",PK:"PAK",PW:"PLW",PS:"PSE",PA:"PAN",PG:"PNG",PY:"PRY",PE:"PER",PH:"PHL",PN:"PCN",PL:"POL",PT:"PRT",PR:"PRI",QA:"QAT",RE:"REU",RO:"ROU",RU:"RUS",RW:"RWA",BL:"BLM",SH:"SHN",KN:"KNA",LC:"LCA",MF:"MAF",PM:"SPM",VC:"VCT",WS:"WSM",SM:"SMR",ST:"STP",SA:"SAU",SN:"SEN",RS:"SRB",SC:"SYC",SL:"SLE",SG:"SGP",SX:"SXM",SK:"SVK",SI:"SVN",SB:"SLB",SO:"SOM",ZA:"ZAF",GS:"SGS",SS:"SSD",ES:"ESP",LK:"LKA",SD:"SDN",SR:"SUR",SJ:"SJM",SZ:"SWZ",SE:"SWE",CH:"CHE",SY:"SYR",TW:"TWN",TJ:"TJK",TZ:"TZA",TH:"THA",TL:"TLS",TG:"TGO",TK:"TKL",TO:"TON",TT:"TTO",TN:"TUN",TR:"TUR",TM:"TKM",TC:"TCA",TV:"TUV",UG:"UGA",UA:"UKR",AE:"ARE",GB:"GBR",UM:"UMI",US:"USA",UY:"URY",UZ:"UZB",VU:"VUT",VE:"VEN",VN:"VNM",VG:"VGB",VI:"VIR",WF:"WLF",EH:"ESH",YE:"YEM",ZM:"ZMB",ZW:"ZWE"},_defaults:{defaultFill:"white",defaultBorderColor:"darkgrey",defaultBorderWidth:.4,defaultBorderHoverWidth:1},createColorRange:function(t,a){for(var e=d3.hsl(t),n=.8/a,l=[],i=0;i<a;i++)e.l=.8-i*n,l.push(e.toString());return l},init:function(t){$(".view-type-map .svg-container").addClass("loading"),d3.json(t,function(t,a){if($(".view-type-map .svg-container").removeClass("loading"),t||a.length<1)return console.warn(t),!1;analysis.map._dataSets=a,analysis.map._width=$(".view-type .svg-container").width(),analysis.map._dataSets.forEach(function(t,a){var e=d3.max(t.data.map(function(t){return t.cnt})),n=analysis.map.createColorRange(t.color,4),l=d3.scale.quantile().domain([1,e]).range(n),i={};t.data.forEach(function(t){var a=l(t.cnt)||n[n.length-1];i[analysis.map._countryCodeMapping[t.country_iso_code]]={count:t.cnt,fillKey:a,highlightFillColor:a}});var s={defaultFill:analysis.map._defaults.defaultFill},r=[];n.forEach(function(t){s[t]=t;var a=l.invertExtent(t);r.push({color:t,name:Math.round(a[0])+" - "+Math.round(a[1])})}),analysis.map._mapDataSets.push({fills:s,labels:r,data:i});var o=$("<button>",{class:"btn btn-default",value:a});o.append($("<span>",{class:"circle",style:"background-color:"+t.color})),o.append($("<span></span>").text(t.label)),$(".view-type-map .btn-group").append(o)}),analysis.map._map=new Datamap({element:$(".view-type-map .svg-container").get(0),projection:"mercator",width:analysis.map._width,height:analysis.map._width/5*3,geographyConfig:{borderColor:analysis.map._defaults.defaultBorderColor,borderWidth:analysis.map._defaults.defaultBorderWidth,highlightFillColor:analysis.map._defaults.defaultFill,highlightBorderColor:analysis.map._defaults.defaultBorderColor,highlightBorderWidth:analysis.map._defaults.defaultBorderHoverWidth,popupTemplate:function(t,a){return text=t.properties.name+": "+(a?a.count:"no")+" mail(s)",$hoverInfo=$("<div>",{class:"hoverinfo",text:text}),$hoverInfo.prop("outerHTML")}},fills:{defaultFill:analysis.map._defaults.defaultFill}}),$(".view-type-map .btn-group button").on("click",function(t){analysis.map.update(this)}),$(".view-type-map .btn-group button:first-child").click()})},update:function(t){$(t).siblings().removeClass("active"),$(t).addClass("active");var a=analysis.map._mapDataSets[$(t).val()],e=analysis.map._dataSets[$(t).val()].label;$(".view-type-map .datamaps-subunits path[data-info]").css({fill:analysis.map._defaults.defaultFill}).attr("data-info",null),analysis.map._map.options.fills=a.fills,analysis.map._map.updateChoropleth(a.data);var n={legendItems:a.labels.map(function(t){return{color:t.color,name:t.name+" mails"}})};analysis.map._map.svg.selectAll("g.legend").remove(),analysis.map._map.svg.append("g").attr("class","legend no-resize").attr("transform","translate(20,20)").call(d3.legend,n).selectAll("g").attr("class","no-resize"),analysis.map._map.svg.selectAll(".map-title").remove(),analysis.map._map.svg.append("text").attr("class","map-title").attr("text-anchor","middle").attr("transform","translate("+analysis.map._width/2+", 30)").style("font-weight","bold").text("Mails per country for '"+e+"'")}},line:{_data:null,_dataSetsLine:null,_defaults:{margin:{top:40,right:60,bottom:120,left:80},marginMini:{top:430,right:60,bottom:20,left:80}},init:function(t){$(".view-type-linechart .svg-container").addClass("loading"),d3.json(t,function(t,a){if($(".view-type-linechart .svg-container").removeClass("loading"),t||a.length<1)return console.warn(t),!1;analysis.line._data=a;var e=d3.time.format("%Y%m%d").parse,n=analysis.line._data.data_sets,l=e(analysis.line._data.begin),i=e(analysis.line._data.end),s=$(".view-type .svg-container").width(),r=s-analysis.line._defaults.margin.left-analysis.line._defaults.margin.right,o=500-analysis.line._defaults.margin.top-analysis.line._defaults.margin.bottom,d=500-analysis.line._defaults.marginMini.top-analysis.line._defaults.marginMini.bottom,p=d3.time.scale().range([0,r]),c=d3.scale.linear().range([o,0]),m=d3.time.scale().range([0,r]),f=d3.scale.linear().range([d,0]),u=d3.time.format.multi([["%b %d",function(t){return 1!=t.getDate()}],["%B",function(t){return t.getMonth()}],["%Y",function(){return!0}]]),g=d3.svg.axis().scale(p).orient("bottom"),h=d3.svg.axis().scale(c).orient("left"),y=d3.svg.axis().scale(m).orient("bottom");g.tickFormat(u);var M=d3.svg.axis().scale(p).orient("bottom").tickSize(-o,0,0).tickFormat(""),A=d3.svg.axis().scale(c).orient("left").tickSize(-r,0,0).tickFormat(""),S=d3.svg.brush().x(m).on("brush",function(){p.domain(S.empty()?m.domain():S.extent()),C.selectAll(".line").attr("d",_),C.select(".x.axis").call(g),C.select(".x.grid").call(M),v.selectAll(".grid .tick").style("stroke","#DADADA"),v.selectAll(".tick text").style("font-size","10px")}).on("brushend",function(){analysis.table.addDateTimeFilter(p.domain())}),v=d3.select(".view-type-linechart .svg-container").append("svg").attr("width",r+analysis.line._defaults.margin.left+analysis.line._defaults.margin.right).attr("height",o+analysis.line._defaults.margin.top+analysis.line._defaults.margin.bottom);v.append("defs").append("clipPath").attr("id","clip").append("rect").attr("width",r).attr("height",500);var C=v.append("g").attr("class","focus").attr("transform","translate("+analysis.line._defaults.margin.left+","+analysis.line._defaults.margin.top+")"),T=v.append("g").attr("class","context").attr("transform","translate("+analysis.line._defaults.marginMini.left+","+analysis.line._defaults.marginMini.top+")"),_=d3.svg.line().x(function(t){return p(t.date)}).y(function(t){return c(t.cnt)}),R=d3.svg.line().x(function(t){return m(t.date)}).y(function(t){return f(t.cnt)});n.forEach(function(t){t.data.forEach(function(t){t.date=e(t.date)})});var B=d3.time.day.range(l,i);n.forEach(function(t){data_len=t.data.length,data_tmp=[];for(var a=0,e=0;e<B.length;e++)data_len>a&&+B[e]==+t.data[a].date?(cnt=t.data[a].cnt,a+=1):cnt=0,data_tmp.push({date:B[e],cnt:cnt});t.data=data_tmp}),p.domain([l,i]),c.domain([0,d3.max([].concat.apply([],n.map(function(t){return t.data.map(function(t){return t.cnt})})))]),m.domain(p.domain()),f.domain(c.domain()),n.forEach(function(t,a){C.append("path").datum(t.data).attr("class","line").attr("d",_).attr("stroke",t.color),T.append("path").datum(t.data).attr("class","line").attr("d",R).attr("stroke",t.color)}),C.append("g").attr("class","x axis").attr("transform","translate(0,"+o+")").call(g),C.append("g").attr("class","y axis").call(h),C.insert("g",":first-child").attr("class","x grid").attr("transform","translate(0,"+o+")").call(M),C.insert("g",":first-child").attr("class","y grid").call(A),v.append("text").attr("class","y label").attr("transform","rotate(-90)translate("+o/2*-1+", 25)").text("Mail count"),T.append("g").attr("class","x axis").attr("transform","translate(0,"+d+")").call(y),T.append("g").attr("class","x brush").call(S).selectAll("rect").attr("y",-6).attr("height",d+7),v.selectAll(".brush .extent").style("stroke","#fff").style("fill-opacity",.125).style("shape-rendering","crispEdges"),v.selectAll(".label").style("text-anchor","middle"),v.selectAll("path").style("stroke-width",2).style("fill","none").style("clip-path","url(#clip)"),v.selectAll("rect").style("stroke-width",2),v.selectAll(".axis path, .axis line").style("fill","none").style("stroke","#DADADA").style("stroke-width",1).style("shape-rendering","crispEdges"),v.selectAll(".grid .tick").style("stroke","#DADADA"),v.selectAll(".tick text").style("font-size","10px"),v.selectAll(".grid path").style("stroke-width",0),C.append("g").attr("class","legend").attr("transform","translate(20,20)").call(d3.legend,{legendItems:n.map(function(t){return{color:t.color,name:t.label}})}),v.append("text").attr("text-anchor","middle").attr("transform","translate("+s/2+", "+analysis.line._defaults.margin.top/2+")").style("font-weight","bold").text("Mails over time")})}},table:{_api:null,_tableTimes:[],addDateTimeFilter:function(t){var a=d3.time.format("%Y/%m/%d");$dataTableWrapper=$(".dataTables_wrapper"),analysis.table._api&&($filterContainer=$dataTableWrapper.find(".table-quick-filter"),$filterContainer.length<1&&($filterContainer=$("<div>",{class:"table-quick-filter"}),$dataTableWrapper.prepend($filterContainer)),$filterContainer.html("Filtering from <strong>"+a(t[0])+"</strong> to <strong>"+a(t[1])+"</strong"),analysis.table._tableTimes=t,analysis.table._api.ajax.reload())},init:function(t){analysis.table._api=$(".view-type-table table").DataTable({ajax:{url:t,type:"POST",data:function(t){return t.custom_filters={time:analysis.table._tableTimes},{data:JSON.stringify(t)}}},searching:!1,serverSide:!0,processing:!0,language:{processing:""}})}},export:{svg:function(t,a,e){var n=$(e).closest(".view-type").find(".svg-container svg").get(0),l=(new XMLSerializer).serializeToString(n);$("<form>",{action:t,target:"_blank",method:"POST"}).append($("<textarea>",{name:"svg"}).val(l)).append($("<input>",{type:"hidden",name:"view_type",value:a})).append($("<input>",{type:"hidden",name:"csrfmiddlewaretoken",value:getCookie("csrftoken")})).hide().appendTo(document.body).submit()},csv:function(t){$("<form>",{action:t,target:"_blank",method:"POST"}).append($("<input>",{type:"hidden",name:"csrfmiddlewaretoken",value:getCookie("csrftoken")})).hide().appendTo(document.body).submit().remove()}}};
d3.legend=function(t,e){return t.each(function(){var t=d3.select(this),n=t.selectAll(".legend-box").data([!0]),l=t.selectAll(".legend-items").data([!0]),r=12,a=r/2;n.enter().append("rect").classed("legend-box",!0),l.enter().append("g").classed("legend-items",!0),n.style("fill","white").style("stroke","black").style("stroke-width","0.5px"),l.selectAll("text").data(e.legendItems).call(function(t){t.enter().append("text")}).call(function(t){t.exit().remove()}).style("font-size",r).attr("transform",function(t,e){return"translate("+(10+2*a+10)+", "+(10+5*e+(e+1)*r-2)+")"}).text(function(t){return t.name}),l.selectAll("circle").data(e.legendItems).call(function(t){t.enter().append("circle")}).call(function(t){t.exit().remove()}).attr("cx",a).attr("cy",a).attr("transform",function(t,e){return"translate(10, "+(2*e*a+5*e+10)+")"}).attr("r",a).style("fill",function(t){return t.color});var c=l[0][0].getBBox();n.attr("height",c.height+20).attr("width",c.width+20)}),t};